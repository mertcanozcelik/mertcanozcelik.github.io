<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş TRL Puanlama Aracı (Mühendislik & Yazılım)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- SheetJS (xlsx) CDN for Excel export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        /* Bölüm Seçici Buton Stilleri (Güncellendi) */
        .section-selector button {
            background-color: #374151; /* gray-700 */
            color: #D1D5DB; /* gray-300 */
        }
        .section-selector button.active {
            background-color: #3B82F6; /* blue-500 */
            color: #FFFFFF;
            font-weight: 700;
        }
        /* Custom Radio Button Stilleri */
        .radio-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            justify-content: flex-start; /* Mobil için sola hizalı */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .radio-group {
                justify-content: flex-end;
            }
        }
        .radio-label {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px; /* rounded-full */
            border: 1px solid #4A5568; /* gray-600 */
            background-color: #2D3748; /* gray-800 */
            color: #A0AEC0; /* gray-400 */
            font-size: 0.75rem;
            transition: all 0.2s ease-in-out;
            text-align: center;
            white-space: nowrap; /* Buton metinlerinin kaymasını engeller */
        }
        .radio-label:hover {
            background-color: #4A5568; /* gray-600 */
            color: #FFFFFF;
        }
        .radio-input {
            display: none;
        }
        .radio-input:checked + .radio-label {
            color: #FFFFFF;
            font-weight: 600;
            border-color: transparent;
        }
        /* Renkler */
        .radio-input[value="0"]:checked + .radio-label { background-color: #718096; } /* gray-500 */
        .radio-input[value="20"]:checked + .radio-label { background-color: #C53030; } /* red-700 */
        .radio-input[value="40"]:checked + .radio-label { background-color: #DD6B20; } /* orange-600 */
        .radio-input[value="60"]:checked + .radio-label { background-color: #D69E2E; } /* yellow-500 */
        .radio-input[value="80"]:checked + .radio-label { background-color: #38A169; } /* green-600 */
        .radio-input[value="100"]:checked + .radio-label { background-color: #3182CE; } /* blue-600 */

        /* Hide default calendar icon for date input */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            width: 100%; /* Make it fill the input to be clickable */
            height: 100%;
            cursor: pointer;
            position: absolute; /* Position over the input */
            top: 0;
            left: 0;
        }
        input[type="date"] {
            position: relative; /* Ensure it's positioned for the indicator */
            padding-right: 2.5rem; /* Make space for the custom icon */
        }
        .date-input-wrapper {
            position: relative;
        }
        .calendar-button {
            position: absolute;
            right: 0.5rem; /* Adjust as needed */
            top: 50%;
            transform: translateY(-50%);
            background-color: white; /* White background for the button */
            border: none;
            padding: 0.3rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            font-size: 1.25rem; /* Adjust emoji size */
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100% - 0.5rem); /* Adjust height to fit input */
            margin-right: 0.25rem; /* Small margin from the right edge */
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Gelişmiş Teknoloji Hazırlık Seviyesi (TRL) Aracı</h1>
            <p class="text-gray-400 mt-2">Kriter bazlı dinamik puanlama ve seviye tespiti.</p>
        </header>

        <!-- Bölüm Seçici -->
        <div id="section-selector" class="flex justify-center mb-8 bg-gray-800 p-1 rounded-lg w-full max-w-md mx-auto section-selector">
            <button id="btn-engineering" class="w-1/2 px-4 py-2 rounded-md font-semibold transition-colors duration-300 active">Genel Mühendislik</button>
            <button id="btn-software" class="w-1/2 px-4 py-2 rounded-md font-semibold transition-colors duration-300">Yazılım</button>
        </div>

        <!-- Proje Bilgileri -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8 border border-gray-700">
            <h2 class="text-lg font-semibold text-gray-400 mb-4">Proje Bilgileri</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-300 mb-1">Proje Adı</label>
                    <input type="text" id="project-name" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="project-manager" class="block text-sm font-medium text-gray-300 mb-1">Proje Sorumlusu</label>
                    <input type="text" id="project-manager" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="project-type" class="block text-sm font-medium text-gray-300 mb-1">Proje Türü</label>
                    <input type="text" id="project-type" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="project-date" class="block text-sm font-medium text-gray-300 mb-1">Tarih</label>
                    <div class="date-input-wrapper w-full">
                        <input type="date" id="project-date" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                        <button type="button" id="calendar-button" class="calendar-button">📅</button>
                    </div>
                </div>
            </div>
            <button id="export-excel-btn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-300 shadow-md">
                Veriyi Excel'e Aktar
            </button>
        </div>

        <!-- Sonuç Alanı -->
        <div id="result-section" class="bg-gray-800 rounded-xl shadow-lg p-6 mb-8 sticky top-4 z-10 border border-gray-700">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="text-center md:text-left">
                    <h2 class="text-lg font-semibold text-gray-400">Hesaplanan Teknoloji Hazırlık Seviyesi</h2>
                    <p id="trl-level-text" class="text-5xl font-extrabold text-white">TRL 0</p>
                    <p id="trl-title-text" class="text-cyan-400 mt-1 text-lg">Değerlendirme için kriterleri puanlayın.</p>
                </div>
                <div class="w-full md:w-1/2">
                    <div class="w-full bg-gray-700 rounded-full h-4">
                        <div id="progress-bar" class="bg-cyan-600 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kriterler Formu -->
        <div id="trl-form" class="space-y-6">
            <!-- TRL seviyeleri buraya dinamik olarak eklenecek -->
        </div>

    </div>

    <script>
        // --- VERİ SETLERİ ---
        const engineeringTrlData = [
            { level: 1, title: "Temel ilkeler gözlemlenmiş ve raporlanmış", criteria: [ { id: "THS1-1", text: "Yeni malzeme ya da teknolojinin temel karakteristikleri tanımlandı mı?" }, { id: "THS1-2", text: "Mühendislik ekibinde görev alan ilgili teknoloji uzmanları teknoloji hakkında bilgilendirilip teknolojinin sağlayacağı fayda ve riskler anlaşıldı mı?" }, { id: "THS1-3", text: "Benzer teknolojiler, yeni mühendislik yetenekleri, yöntemleri ve araçlarının geliştirilmesine olanak sağlandı mı?" }, { id: "THS1-4", text: "Teknolojinin geliştirilme ve ölçeklenme süresince riskler tanımlandı mı?" }, { id: "THS1-5", text: "Teknoloji çalışmasını tetikleyen gereksinimler tanımlandı mı?" } ] },
            { level: 2, title: "Teknoloji kavramı ve / veya uygulaması formüle edilmiş", criteria: [ { id: "THS2-1", text: "Teknolojinin kullanım alanlarındaki rekabetçilerine (yeni yetkinlikler, metot, araç vb.) ve tedarik zincirine etkisinin ön değerlendirmesi yapıldı mı?" }, { id: "THS2-2", text: "Potansiyel uygulamalar tanımlandı mı?" }, { id: "THS2-3", text: "Ön performans tahminleri yapıldı mı?" }, { id: "THS2-4", text: "Ön analitik çalışmalar temel kavramı doğruladı mı?" } ] },
            { level: 3, title: "Kavramın analitik ve deneysel olarak kritik işlev ve / veya karakteristik (ayırt edici özellik) olarak ispatlanması", criteria: [ { id: "THS3-1", text: "Kavram/uygulamanın kritik fonksiyonları/bileşenleri belirlendi mi?" }, { id: "THS3-2", text: "Anahtar parametreler için ön performans metrikleri saptandı mı?" }, { id: "THS3-3", text: "Malzeme ve sürecin ürüne ve endüstriyel ortama entegrasyonunun ön değerlendirmesi yapıldı mı?" }, { id: "THS3-4", text: "Teknolojik ürünün entegre edeceği ürün Grubu’nun uyumu sağlandı mı?" } ] },
            { level: 4, title: "Düşük sadakatli bileşen veya deney modelinin temel fonksiyonları laboratuvar ortamında geçerli kılınması", criteria: [ { id: "THS4-1", text: "Kavram / uygulama, detaylı sistem / alt sistem / bileşen seviyesinde deney platformu tasarımına çevrildi mi?" }, { id: "THS4-2", text: "Modelleme ve simülasyon ile laboratuvar test ölçüsü performans tahminleri değerlendirildi mi?" }, { id: "THS4-3", text: "Laboratuvar testleri için performans metrikleri oluşturuldu mu? İlgili test ortamı tanımlandı mı?" } ] },
            { level: 5, title: "Orta sadakatli bileşen veya deney modeli elverişli edilen işletim ortamında doğrulanmış", criteria: [ { id: "THS5-1", text: "Sistem arayüz gereksinimleri belirlendi mi?" }, { id: "THS5-2", text: "Daha sonraki geliştirme fazları için sistem seviyesi performans tahminleri yapıldı mı?" }, { id: "THS5-3", text: "Orta sadakat seviyesindeki deney modelinin gösterimi yapıldı mı?" }, { id: "THS5-4", text: "Boyutlandırılamayan, lineer olmayan hedeflenen uygulama için ilgili tasarım prensipleri doğrulandı mı?" } ] },
            { level: 6, title: "Tam sistem prototipinin benzetimli işletim ortamında çalıştırılarak kritik çevre koşullarında çalıştığının gösterimi yapılmış", criteria: [ { id: "THS6-1", text: "Operasyonel ortama yakın son haline getirildi mi? Kritik noktalar belirlendi mi?" }, { id: "THS6-2", text: "Yüksek sadakatli tam ölçekli prototip bütün kritik ölçek gereksinimlerini sağlayacak şekilde imal edildi mi?" }, { id: "THS6-3", text: "Tam ölçekli prototip ilgili ortamda çalıştırılarak kritik çevre koşullarında çalıştığının gösterimi yapıldı mı?" } ] },
            { level: 7, title: "Sistem prototipinin gerçek operasyon ortamında çalıştığının gösterimi yapılmış", criteria: [ { id: "THS7-1", text: "Sistem tasarımının temeli (Baseline) oluşturuldu mu?" }, { id: "THS7-2", text: "Prototipte / pilot sistemde modellenen bileşenler, üretimde kullanılacak bileşenleri temsil edecek şekilde yükseltildi mi?" }, { id: "THS7-3", text: "Tasarım, tüm kritik ölçekleri dikkate alacak şekilde yapıldı mı?" }, { id: "THS7-4", text: "Entegre mühendislik modeli ya da ölçekli prototip ünitesi tüm kritik ölçekleri ve dış ara yüzleri içerecek şekilde üretildi mi?" }, { id: "THS7-5", text: "Entegre prototip ünitesinin operasyonel ortamda başarıyla görev yaptığı gösterildi mi?" }, { id: "THS7-6", text: "Entegre edilmiş prototipin operasyonel ortamda risk gösterimi yapıldı mı?" } ] },
            { level: 8, title: "Son ürünün nihai konfigürasyonu ile planlı operasyonel sistem ve platformda başarı ile çalıştığının gösterimi test ve analizler ile gerçekleştirilmiş", criteria: [ { id: "THS8-1", text: "Alt sistem tasarımları tamamlandı mı?" }, { id: "THS8-2", text: "Tüm donanım ara yüzleri tanımlandı mı?" }, { id: "THS8-3", text: "Sistem tasarımı tamamlandı mı?" }, { id: "THS8-4", text: "Nihai ürüne entegre edilecek bileşen / alt sistem / sistem donanımlarının kabul testleri tamamlandı mı?" } ] },
            { level: 9, title: "Son ürün göreve başlamış/tamamlanmış", criteria: [ { id: "THS9-1", text: "Son ürün operasyonel olarak ispatlandı mı?" }, { id: "THS9-2", text: "Son ürünün performansının, operasyonel gereksinimleri karşıladığı doğrulandı mı?" }, { id: "THS9-3", text: "Operasyonel gereksinimlerin karşılandığını gösteren doğrulama kayıtları dokümante edildi mi?" } ] }
        ];
        const softwareTrlData = [
            { level: 1, title: "Temel Bilimsel Araştırmalar: Yazılım ürününün matematiksel formülasyonları ve temel özelliklerine ilişkin bilimsel bilginin geliştirildiği aşamadır.", criteria: [
                { id: "THS1-1", text: "Yazılım gereksinimleri genel hatlarıyla tamamlandı mı?" },
                { id: "THS1-2", text: "Hedeflenen yazılım ürününün temel özellikleri, matematiksel formülasyonu ve genel algoritmasını destekleyen yayınlar, bilimsel bilgiler elde edildi mi?" },
                { id: "THS1-3", text: "Destekleyici/sınayıcı temel prensipler, bilimsel kurallar ve varsayımlar gözlemlendi ve doğrulandı mı?" },
                { id: "THS1-4", text: "Gözlem ve doğrulama/sınama araştırmaları sonucunda yazılım mimarisine ilişkin bilimsel bilgi geliştirildi mi?" }
            ] },
            { level: 2, title: "Yazılım Konsepti: Tasarım: Yazılım konseptinin, temel özelliklerinin ve modelleriyle potansiyel uygulama/alanlarının formüle edildiği aşamadır.", criteria: [
                { id: "THS2-1", text: "Hedeflenen yazılımın potansiyel uygulanabilirliği belirlendi mı?" },
                { id: "THS2-2", text: "Potansiyel uygulama alanlarının yapılabilirliği (fizibilitesi) doğrulandı mı?" },
                { id: "THS2-3", text: "Algoritmaların ve yazılım konseptinin temel özellikleri tanımlandı mı?" },
                { id: "THS2-4", text: "Yazılımın üzerinde çalışacağı donanım halihazırda mevcut mu?" }
            ] },
            { level: 3, title: "Yazılımın kritik performans özelliklerinin doğrulanması amacıyla, entegre edilmemiş yazılım bileşenleri kullanılarak, kritik işlevselliğin (limited functionality) geliştirildiği aşamasıdır.", criteria: [
                { id: "THS3-1", text: "Yazılımın performans ve etkileşim gereksinim algoritmaları analitik çalışmalarla doğrulandı mı?" },
                { id: "THS3-2", text: "Yazılıma ilişkin algoritmaların ana hatları dokümante edildi mı?" },
                { id: "THS3-3", text: "İlk yazılım kodlamaları, yazılımın operasyonel gereksinimlerini karşılar doğrulandı mı?" },
                { id: "THS3-4", text: "Destekleyici/sınayıcı temel prensipler, bilimsel kurallar ve varsayımlar gözlemlendi ve doğrulandı mı? (Test-Harness)" }
            ] },
            { level: 4, title: "Yazılımın kritik bileşenlerinin entegre edildiği, fonksiyonellik bakımından doğrulandığı, birarada çalışabilirliğinin (interoperability) ve sistem mimarisinin geliştirilmeye başlandığı aşamadır.", criteria: [
                { id: "THS4-1", text: "Veri formatlarının analizi sağlanarak, her bir modülün yazılım mimari modeliyle uyumluluğu sağlandı mı?" },
                { id: "THS4-2", text: "Yazılım, yapay tam ölçek problemleri çözümlüyor veya temsili veri setlerini tam olarak işleyebiliyor mu?" },
                { id: "THS4-3", text: "Tüm işlevlerin veya modüllerin geçici entegrasyonunun laboratuvar ortamında fiziki gösterimi yapıldı mı?" },
                { id: "THS4-4", text: "Entegre edilen işlevlerin veya modüllerin fonksiyonel olarak doğrulaması yapıldı mı?" },
                { id: "THS4-5", text: "Yazılım mimari modelinin birlikte çalışabilirlik(interoperability), ölçeklenebilirlik(scalability) ve gözden geçirilebilirlik(reviewability) konularını test ederek geliştirilmesine başlandı mı?" }
            ] },
            { level: 5, title: "Simüle edilmiş (benzetimli) ortamda, uçtan uca yazılım unsurlarının (işlevler/modüller) entegre edildiği, arayüzlerin geliştirildiği ve fiziki gösteriminin yapıldığı aşamadır.", criteria: [
                { id: "THS5-1", text: "Her bir işlevin/modülün kodlaması ve hata ayıklaması tamamlandı mı?" },
                { id: "THS5-2", text: "İşlevlerin/modüllerin simüle edilmiş ortamda uyumlu mevcut sistemler/simülasyonlar ile arayüzleri geliştirildi mi?" },
                { id: "THS5-3", text: "İşlevlerin/modüllerin simüle edilmiş ortamda entegrasyonunun fiziki gösterimi yapıldı mı?" },
                { id: "THS5-4", text: "Yazılım mimarisi, veritabanı ve arayüzleri tasarısı tamamlandı mı?" }
            ] },
            { level: 6, title: "Prototip geliştirme tamamlandı, tam ölçekteki gerçekçi problemler ile test edildiği ve fiziki gösteriminin yapıldığı aşamadır. (Yazılımın ön versiyonu)", criteria: [
                { id: "THS6-1", text: "Yazılımın geliştirme ve test belgeleri dokümante edildi mi?" },
                { id: "THS6-2", text: "Yazılım algoritmasının (theoric) görevini tam sistem ile entegre edildi mi?" },
                { id: "THS6-3", text: "Yazılım geliştirme belgeleri(kurulum, belgeleme, bakım belgeleri, eğitim belgeleri) hazırlanmaya başlandı mı?" },
                { id: "THS6-4", text: "Zamanlama kısıtlarının (timing constraints) ve yazılım prototipinin mühendislik fizibilite analizi tamamlanarak fiziki gösterimi yapıldı mı? (Demonstration)" }
            ] },
            { level: 7, title: "Gerçek (Operasyonel) ortamda prototipin fiziki gösterimi: Yazılım prototipinde gerçek ortamda tüm fonksiyonların fiziki gösteriminin yapıldığı aşamadır. (Yazılımın çalışır versiyonu)", criteria: [
                { id: "THS7-1", text: "Operasyonel fizibilite gösterimi: donatım/yazılım sistemlerinin, tüm kilit işlevlere sahip olacak şekilde entegrasyonu başarılı bir şekilde yapıldı mı?" },
                { id: "THS7-2", text: "Yazılım prototipi fiziki gösterim (demonstration) ve test için gereken tüm kilit işlevlere sahip olacak şekilde tamamlandı mı?" },
                { id: "THS7-3", text: "Yazılım geliştirme belgeleri kısmen hazırlandı mı?" },
                { id: "THS7-4", text: "Entegre edilmiş yazılım prototipinin, gerçek (operasyonel) ortamda fiziki gösterimi yapıldı mı?" }
            ] },
            { level: 8, title: "Gerçek ortamda yazılım performans değerlendirmeleri ve belgelendirilmesi: Yazılımın geliştirme sürecinin tamamlandığı, operasyonel olarak ve son kullanıcıya beklenen koşullar altında çalışır durumda olduğu aşamadır. (Yazılımın ilk versiyonu- v 1.0)", criteria: [
                { id: "THS8-1", text: "Yazılım teknolojisi operasyonel donanım ve yazılım sistemiyle tam olarak entegre edildi mi?" },
                { id: "THS8-2", text: "Yazılım hatalaması tamamlandı mı?" },
                { id: "THS8-3", text: "Yazılım geliştirme ve belgeleri tamamlandı mı?" },
                { id: "THS8-4", text: "Yazılımın tüm işlevlerinin, simüle edilmiş operasyonel senaryolarda başarılı bir şekilde fiziki gösterimi yapıldı mı?" },
                { id: "THS8-5", text: "Teknoloji ve yazılım “Gerçekleme ve Doğrulama” (Verification and Validation) tamamlandı mı?" }
            ] },
            { level: 9, title: "Gerçek Ortamda Başarı ile Performans Gösteren Teknoloji/Sistem: Geliştirilen teknoloji/sistemin gerçek ortamında çalışır durumda olduğunun kanıtlandığı aşamadır.", criteria: [
                { id: "THS9-1", text: "Yazılım teknolojisi gerçek ortamda ve gerçek senaryolarda donanım ve yazılım sistemleriyle birlikte çalışır durumda mı?" },
                { id: "THS9-2", text: "Yazılım teknolojisi gerçek ortamda hazırda,tekrar edilebilir ve yeniden kullanılabilir şekilde mi?" },
                { id: "THS9-3", text: "Yazılım mühendisliği desteği mevcut ve sürülebilir durumda mı?" }
            ] }
        ];
        const completionOptions = [ { text: "Başlanmadı", value: 0 }, { text: "Yeni Başlandı", value: 20 }, { text: "Başlandı", value: 40 }, { text: "Az İlerleme", value: 60 }, { text: "Yarısı Tamamlandı", value: 80 }, { text: "Tamamlandı", value: 100 } ];

        // --- DOM Elementleri ---
        const form = document.getElementById('trl-form');
        const levelText = document.getElementById('trl-level-text');
        const titleText = document.getElementById('trl-title-text');
        const progressBar = document.getElementById('progress-bar');
        const btnEngineering = document.getElementById('btn-engineering');
        const btnSoftware = document.getElementById('btn-software');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const projectDateInput = document.getElementById('project-date');
        const calendarButton = document.getElementById('calendar-button');


        let currentData = engineeringTrlData;

        // --- FONKSİYONLAR ---

        function renderSection(data) {
            currentData = data;
            form.innerHTML = ''; // Formu temizle

            data.forEach((levelData) => {
                const section = document.createElement('div');
                section.className = 'bg-gray-800 p-4 md:p-6 rounded-lg border border-gray-700';
                
                // Başlık ve Seviye Puanı Alanı
                section.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <div class="md:w-2/3">
                            <h3 class="text-xl font-bold text-cyan-500">TRL ${levelData.level}: ${levelData.title}</h3>
                        </div>
                        <div class="w-full md:w-1/3 mt-2 md:mt-0 text-right">
                             <div class="flex items-center gap-2 justify-end">
                                 <span id="score-${levelData.level}" class="text-lg font-bold">0%</span>
                                 <div class="w-full bg-gray-700 rounded-full h-2.5">
                                     <div id="progress-${levelData.level}" class="bg-blue-600 h-2.5 rounded-full progress-bar-inner" style="width: 0%"></div>
                                 </div>
                             </div>
                        </div>
                    </div>
                `;

                const criteriaContainer = document.createElement('div');
                criteriaContainer.className = 'space-y-4';

                levelData.criteria.forEach((criterion) => {
                    const criterionRow = document.createElement('div');
                    // Geliştirilmiş grid yapısı ile hizalama sorunu çözüldü
                    criterionRow.className = 'grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-2 items-center border-t border-gray-700 pt-4';

                    const criterionText = document.createElement('p');
                    criterionText.className = 'text-gray-300 text-sm md:col-span-7'; // Metin alanı daha geniş
                    criterionText.innerHTML = `<span class="font-semibold text-gray-100">${criterion.id}:</span> ${criterion.text}`;
                    
                    const radioGroup = document.createElement('div');
                    radioGroup.className = 'radio-group md:col-span-5'; // Buton grubu
                    radioGroup.dataset.level = levelData.level;

                    completionOptions.forEach(option => {
                        const radioId = `${criterion.id}-${option.value}`;
                        const radioInput = document.createElement('input');
                        radioInput.type = 'radio';
                        radioInput.id = radioId;
                        radioInput.name = criterion.id;
                        radioInput.value = option.value;
                        radioInput.className = 'radio-input';
                        radioInput.addEventListener('change', calculateTRL);
                        
                        if(option.value === 0) radioInput.checked = true;

                        const radioLabel = document.createElement('label');
                        radioLabel.htmlFor = radioId;
                        radioLabel.className = 'radio-label';
                        radioLabel.textContent = option.text;

                        radioGroup.appendChild(radioInput);
                        radioGroup.appendChild(radioLabel);
                    });

                    criterionRow.appendChild(criterionText);
                    criterionRow.appendChild(radioGroup);
                    criteriaContainer.appendChild(criterionRow);
                });

                section.appendChild(criteriaContainer);
                form.appendChild(section);
            });
            calculateTRL(); // Yeni bölüm render edildikten sonra hesaplama yap
        }

        function calculateTRL() {
            let finalTRL = 0;
            let allPreviousLevelsPassed = true;

            currentData.forEach(levelData => {
                let sumOfScores = 0;
                levelData.criteria.forEach(criterion => {
                    const selectedRadio = document.querySelector(`input[name='${criterion.id}']:checked`);
                    if(selectedRadio) {
                        sumOfScores += parseInt(selectedRadio.value, 10);
                    }
                });

                const averageScore = levelData.criteria.length > 0 ? (sumOfScores / levelData.criteria.length) : 0;
                
                updateLevelUI(levelData.level, averageScore);

                // Kural: >= 80
                if (allPreviousLevelsPassed && averageScore >= 80) {
                    finalTRL = levelData.level;
                } else {
                    allPreviousLevelsPassed = false;
                }
            });
            
            updateOverallUI(finalTRL);
        }

        function updateLevelUI(level, score) {
            const scoreEl = document.getElementById(`score-${level}`);
            const progressEl = document.getElementById(`progress-${level}`);
            
            if(!scoreEl || !progressEl) return;

            scoreEl.textContent = `${Math.round(score)}%`;
            progressEl.style.width = `${score}%`;

            if (score < 80) progressEl.style.backgroundColor = '#DD6B20'; // orange
            else progressEl.style.backgroundColor = '#38A169'; // green
        }

        function updateOverallUI(level) {
            levelText.textContent = `TRL ${level}`;
            
            if (level > 0) {
                titleText.textContent = currentData[level - 1].title;
            } else {
                titleText.textContent = "Değerlendirme için kriterleri puanlayın.";
            }

            const progressPercentage = (level / currentData.length) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function exportToExcel() {
            const projectName = document.getElementById('project-name').value || 'N/A';
            const projectManager = document.getElementById('project-manager').value || 'N/A';
            const projectType = document.getElementById('project-type').value || 'N/A';
            const projectDate = document.getElementById('project-date').value || 'N/A';
            const currentTRLLevel = levelText.textContent; // "TRL X"
            const currentTRLTitle = titleText.textContent; // "Başlık metni"

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws_data = [];
            const merges = []; // Array to store merge ranges

            // Add project information
            ws_data.push(["Proje Adı:", projectName]);
            ws_data.push(["Proje Sorumlusu:", projectManager]);
            ws_data.push(["Proje Türü:", projectType]);
            ws_data.push(["Tarih:", projectDate]);
            ws_data.push([]); // Empty row for separation

            // Add calculated TRL Level and Title
            ws_data.push(["Hesaplanan TRL Seviyesi:", currentTRLLevel]);
            ws_data.push(["Hesaplanan TRL Başlığı:", currentTRLTitle]);
            ws_data.push([]); // Empty row for separation

            // Add header row for TRL criteria
            const headerRowIndex = ws_data.length; 
            ws_data.push([
                "TRL Seviyesi", "TRL Başlığı", "Kriter ID", "Kriter Metni", "Puan"
            ]);

            let currentRowIndex = ws_data.length; // This will be the starting row for the first TRL criteria

            // Add TRL data rows and define merges
            currentData.forEach(levelData => {
                const startRowForLevel = currentRowIndex;
                levelData.criteria.forEach(criterion => {
                    const selectedRadio = document.querySelector(`input[name='${criterion.id}']:checked`);
                    const score = selectedRadio ? selectedRadio.value : '0';
                    
                    ws_data.push([
                        `TRL ${levelData.level}`,
                        levelData.title,
                        criterion.id,
                        criterion.text,
                        score
                    ]);
                    currentRowIndex++;
                });
                const endRowForLevel = currentRowIndex - 1;

                // Add merge directives for TRL Level and TRL Title columns for this level
                if (startRowForLevel <= endRowForLevel) { // Only merge if there are criteria for this level
                    merges.push({ s: { r: startRowForLevel, c: 0 }, e: { r: endRowForLevel, c: 0 } }); // Merge TRL Seviyesi column (column A)
                    merges.push({ s: { r: startRowForLevel, c: 1 }, e: { r: endRowForLevel, c: 1 } }); // Merge TRL Başlığı column (column B)
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Apply merges to the worksheet
            if (merges.length > 0) {
                ws['!merges'] = merges;
            }

            XLSX.utils.book_append_sheet(wb, ws, "TRL Değerlendirme");

            // Write file
            XLSX.writeFile(wb, 'TRL_Degerlendirme.xlsx');
        }


        // --- OLAY DİNLEYİCİLER ---
        btnEngineering.addEventListener('click', () => {
            btnEngineering.classList.add('active');
            btnSoftware.classList.remove('active');
            renderSection(engineeringTrlData);
        });

        btnSoftware.addEventListener('click', () => {
            btnSoftware.classList.add('active');
            btnEngineering.classList.remove('active');
            renderSection(softwareTrlData);
        });

        exportExcelBtn.addEventListener('click', exportToExcel);

        // Add event listener for the custom calendar button
        calendarButton.addEventListener('click', () => {
            projectDateInput.showPicker(); // Modern browsers
            // Fallback for older browsers if showPicker() is not supported,
            // though direct focus might not always open the picker.
            // projectDateInput.focus(); 
        });

        // --- BAŞLANGIÇ ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSection(engineeringTrlData); // Başlangıçta mühendislik bölümünü yükle
        });
    </script>
</body>
</html>
